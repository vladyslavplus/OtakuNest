<div class="cart-page">
    <div class="cart-header">
        <h1 class="cart-title">
            <svg class="cart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="9" cy="21" r="1" />
                <circle cx="20" cy="21" r="1" />
                <path d="m1 1 4 4.36 2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
            </svg>  
            Your Shopping Cart
        </h1>
        <div class="items-count" *ngIf="detailedCartItems.length > 0">
            {{ totalQuantity }} {{ totalQuantity === 1 ? 'item' : 'items' }}
        </div>
    </div>

    <div class="error-message" *ngIf="error" role="alert">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10" />
            <line x1="15" y1="9" x2="9" y2="15" />
            <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
        <span>{{ error }}</span>
        <button class="close-error" (click)="clearError()" aria-label="Close error">Ã—</button>
    </div>

    <div class="loading-container" *ngIf="isLoading">
        <div class="loading-spinner"></div>
        <p>Loading your cart...</p>
    </div>

    <div class="empty-cart" *ngIf="!isLoading && detailedCartItems.length === 0">
        <div class="empty-cart-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="9" cy="21" r="1" />
                <circle cx="20" cy="21" r="1" />
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
            </svg>
        </div>
        <h2>Your cart is empty</h2>
        <p>Add some products to your cart to get started!</p>
        <button class="continue-shopping-btn" routerLink="/products">
            Continue Shopping
        </button>
    </div>

    <div class="cart-content" *ngIf="!isLoading && detailedCartItems.length > 0">
        <div class="cart-items">
            <div class="cart-item" *ngFor="let item of detailedCartItems; trackBy: trackByProductId">
                <div class="item-image">
                    <img *ngIf="item.imageUrl" [src]="item.imageUrl" [alt]="item.productName" class="product-image"
                        (error)="onImageError($event)">
                    <div *ngIf="!item.imageUrl" class="product-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <polyline points="21,15 16,10 5,21" />
                        </svg>
                    </div>
                </div>

                <div class="item-details">
                    <h3 class="product-name">{{ item.productName }}</h3>
                    <div class="product-meta">
                        <span class="unit-price">{{ item.unitPrice | currency }}</span>
                        <span class="stock-status" [ngClass]="getStockStatusClass(item)">
                            {{ getStockMessage(item) }}
                        </span>
                    </div>
                </div>

                <div class="quantity-controls">
                    <button class="quantity-btn decrease" (click)="decreaseQuantity(item.productId)"
                        [disabled]="!canDecreaseQuantity(item)"
                        [class.loading]="pendingRequests.has('decrease_' + item.productId)"
                        aria-label="Decrease quantity">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                    </button>

                    <span class="quantity-display">{{ item.quantity }}</span>

                    <button class="quantity-btn increase" (click)="increaseQuantity(item.productId)"
                        [disabled]="!canIncreaseQuantity(item)"
                        [class.loading]="pendingRequests.has('increase_' + item.productId)"
                        [title]="!canIncreaseQuantity(item) ? 'Maximum quantity reached' : 'Increase quantity'"
                        aria-label="Increase quantity">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                    </button>
                </div>

                <div class="item-total">
                    <span class="total-price">{{ item.quantity * item.unitPrice | currency }}</span>
                </div>

                <button class="remove-btn" (click)="removeItem(item.productId)"
                    [disabled]="!canRemoveItem(item.productId)"
                    [class.loading]="pendingRequests.has('remove_' + item.productId)" aria-label="Remove item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="3,6 5,6 21,6" />
                        <path d="M19,6V20a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6" />
                        <line x1="10" y1="11" x2="10" y2="17" />
                        <line x1="14" y1="11" x2="14" y2="17" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="cart-summary">
            <div class="summary-content">
                <h3>Order Summary</h3>

                <div class="summary-row">
                    <span>Subtotal ({{ totalQuantity }} items)</span>
                    <span>{{ totalPrice | currency }}</span>
                </div>

                <div class="summary-row">
                    <span>Shipping</span>
                    <span class="free-shipping">Free</span>
                </div>

                <div class="summary-row">
                    <span>Tax</span>
                    <span>Calculated at checkout</span>
                </div>

                <hr class="summary-divider">

                <div class="summary-row total">
                    <span>Total</span>
                    <span>{{ totalPrice | currency }}</span>
                </div>

                <button class="checkout-btn" (click)="goToOrderPage()">
                    <svg class="checkout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M9 12l2 2 4-4" />
                    </svg>
                    Proceed to Checkout
                  </button>

                <button class="continue-shopping-link" routerLink="/products">
                    Continue Shopping
                </button>
            </div>
        </div>
    </div>
</div>