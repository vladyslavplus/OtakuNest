<div class="order-page">
    <div class="order-header">
        <div class="header-content">
            <h1 class="order-title">
                <svg class="checkout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 12l2 2 4-4" />
                    <circle cx="12" cy="12" r="10" />
                </svg>
                Checkout
            </h1>
            <div class="breadcrumb">
                <span class="breadcrumb-item">Cart</span>
                <svg class="breadcrumb-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="9,18 15,12 9,6" />
                </svg>
                <span class="breadcrumb-item active">Checkout</span>
            </div>
        </div>
        <button class="back-to-cart-btn compact" (click)="goBackToCart()" [disabled]="isSubmitting">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="15,18 9,12 15,6" />
            </svg>
            Back to Cart
        </button>
    </div>

    <div *ngIf="error" class="error-message" role="alert">
        <div class="error-content">
            <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
            </svg>
            <span class="error-text">{{ error }}</span>
        </div>
        <button class="close-error-btn" (click)="clearError()" aria-label="Close error">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
        </button>
    </div>

    <div *ngIf="isSubmitting || isOrderCompleted" class="loading-overlay">
        <div class="loading-content" [class.completed]="isOrderCompleted">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="((currentStageIndex + 1) / orderStages.length) * 100"></div>
                </div>
            </div>

            <div class="order-stages">
                <div *ngFor="let stage of orderStages; let i = index" 
                     class="stage-item" 
                     [class.active]="stage.status === 'active'"
                     [class.completed]="stage.status === 'completed'"
                     [class.pending]="stage.status === 'pending'">
                    
                    <div class="stage-icon">
                        <svg *ngIf="stage.id === 'validating' && stage.status !== 'completed'" 
                             viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                        </svg>
                        
                        <svg *ngIf="stage.id === 'processing' && stage.status !== 'completed'" 
                             viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <path d="M16 10a4 4 0 0 1-8 0" />
                        </svg>
                        
                        <svg *ngIf="stage.id === 'completing' && stage.status !== 'completed'" 
                             viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 8a2 2 0 0 0-1-1.73L12 2 4 6.27A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73L12 22l8-4.27A2 2 0 0 0 21 16V8z" />
                            <path d="M17 8L12 13 7 8" />
                        </svg>
                        
                        <svg *ngIf="stage.status === 'completed'" 
                             viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M9 12l2 2 4-4" />
                            <circle cx="12" cy="12" r="10" />
                        </svg>
                        
                    </div>
                    
                    <div class="stage-label">{{ stage.label }}</div>
                </div>
            </div>

            <h3 *ngIf="!isOrderCompleted" class="loading-title">Processing Your Order</h3>
            <h3 *ngIf="isOrderCompleted" class="success-title">
                <svg class="success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 12l2 2 4-4" />
                    <circle cx="12" cy="12" r="10" />
                </svg>
                Order Successfully Created!
            </h3>

            <p *ngIf="!isOrderCompleted" class="loading-message">
                Please wait while we process your order...
            </p>
            
            <div *ngIf="isOrderCompleted" class="success-message">
                <p>Your order has been successfully created and is being prepared for shipment.</p>
                <p *ngIf="completedOrder?.id" class="order-id">Order ID: <strong>#{{ completedOrder?.id }}</strong></p>
            </div>

            <div *ngIf="isOrderCompleted" class="completion-actions">
                <button class="btn-primary-large" (click)="navigateToHome()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                        <polyline points="9,22 9,12 15,12 15,22" />
                    </svg>
                    Continue Shopping
                </button>
                
                <div class="auto-redirect-notice">
                    Automatically redirecting in <strong>{{ autoRedirectCountdown }}</strong> seconds...
                </div>
            </div>
        </div>
    </div>

    <div class="order-content" [class.disabled]="isSubmitting">
        <div class="order-summary-card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg class="summary-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                    </svg>
                    Order Summary
                </h2>
                <div class="items-count">{{ getTotalQuantity() }} {{ getTotalQuantity() === 1 ? 'item' : 'items' }}
                </div>
            </div>

            <div class="items-list">
                <div *ngFor="let item of cartItems; trackBy: trackByProductId" class="order-item">
                    <div class="item-image-wrapper">
                        <img *ngIf="item.imageUrl" [src]="item.imageUrl" [alt]="item.productName" class="item-image"
                            (error)="onImageError($event)">
                        <div *ngIf="!item.imageUrl" class="item-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21,15 16,10 5,21" />
                            </svg>
                        </div>
                        <div class="availability-badge" [ngClass]="item.isAvailable ? 'available' : 'unavailable'">
                            <svg *ngIf="item.isAvailable" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M9 12l2 2 4-4" />
                            </svg>
                            <svg *ngIf="!item.isAvailable" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                            </svg>
                        </div>
                    </div>

                    <div class="item-details">
                        <h3 class="item-name">{{ item.productName }}</h3>
                        <div class="item-meta">
                            <span class="unit-price">{{ item.unitPrice | currency }}</span>
                            <span class="quantity">Ã— {{ item.quantity }}</span>
                        </div>
                        <div *ngIf="!item.isAvailable" class="unavailable-notice">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <polygon points="10.29,3 21.71,21 2.29,21" />
                                <line x1="12" y1="9" x2="12" y2="13" />
                                <line x1="12" y1="17" x2="12.01" y2="17" />
                            </svg>
                            Currently unavailable
                        </div>
                    </div>

                    <div class="item-total">
                        <span class="total-price">{{ item.quantity * item.unitPrice | currency }}</span>
                    </div>
                </div>
            </div>

            <div class="order-totals">
                <div class="total-row">
                    <span>Subtotal ({{ getTotalQuantity() }} items)</span>
                    <span>{{ getTotalPrice() | currency }}</span>
                </div>
                <div class="total-row">
                    <span>Shipping</span>
                    <span class="free-shipping">Free</span>
                </div>
                <div class="total-row">
                    <span>Tax</span>
                    <span class="calculated-later">Calculated at checkout</span>
                </div>
                <hr class="totals-divider">
                <div class="total-row final-total">
                    <span>Total</span>
                    <span>{{ getTotalPrice() | currency }}</span>
                </div>
            </div>
        </div>

        <div class="shipping-card">
            <div class="card-header">
                <h2 class="card-title">
                    <svg class="shipping-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M1 3h15v13H1z" />
                        <path d="M16 8h4l3 3v5h-7V8z" />
                        <circle cx="5.5" cy="18.5" r="2.5" />
                        <circle cx="18.5" cy="18.5" r="2.5" />
                    </svg>
                    Shipping Information
                </h2>
            </div>

            <form class="shipping-form" (ngSubmit)="submitOrder()" #orderForm="ngForm">
                <div class="form-group">
                    <label for="shippingAddress" class="form-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                            <circle cx="12" cy="10" r="3" />
                        </svg>
                        Shipping Address
                        <span class="required">*</span>
                    </label>
                    <div class="input-wrapper">
                        <textarea id="shippingAddress" name="shippingAddress" [(ngModel)]="shippingAddress" required
                            rows="3" maxlength="300"
                            placeholder="Enter your complete shipping address including street, city, state, and postal code..."
                            class="form-textarea compact" [class.error]="!shippingAddress.trim() && orderForm.submitted"
                            [disabled]="isSubmitting">
                        </textarea>
                        <div class="character-count" [class.near-limit]="shippingAddress.length > 200">
                            {{ shippingAddress.length }}/300
                        </div>
                    </div>
                    <div *ngIf="!shippingAddress.trim() && orderForm.submitted" class="field-error">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="15" y1="9" x2="9" y2="15" />
                            <line x1="9" y1="9" x2="15" y2="15" />
                        </svg>
                        Shipping address is required
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary compact" (click)="goBackToCart()"
                        [disabled]="isSubmitting">
                        Back to Cart
                    </button>
                    <button type="submit" class="btn-primary compact"
                        [disabled]="isSubmitting || !shippingAddress.trim() || cartItems.length === 0">
                        <svg *ngIf="!isSubmitting" class="btn-icon" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor">
                            <path d="M9 12l2 2 4-4" />
                        </svg>
                        <div *ngIf="isSubmitting" class="btn-spinner"></div>
                        <span *ngIf="!isSubmitting">Place Order ({{ getTotalPrice() | currency }})</span>
                        <span *ngIf="isSubmitting">Processing...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="security-notice">
        <div class="security-content">
            <svg class="security-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                <path d="M9 12l2 2 4-4" />
            </svg>
            <div class="security-text">
                <strong>Secure Checkout </strong>
                <span>Your payment and personal information are protected with SSL encryption.</span>
            </div>
        </div>
    </div>
</div>